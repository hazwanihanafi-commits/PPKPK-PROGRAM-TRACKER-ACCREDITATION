<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Programme SRR Dashboard</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f6f8fb;
  padding:24px;
}

h2{ margin-bottom:16px }

.area-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:16px;
}

.area-card{
  background:white;
  border-radius:12px;
  padding:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
  cursor:pointer;
}

.progress{
  height:8px;
  background:#eee;
  border-radius:6px;
  overflow:hidden;
  margin:10px 0;
}

.progress-bar{
  height:100%;
  background:#22c55e;
  width:0%;
}

.badge{
  font-size:12px;
  padding:4px 10px;
  border-radius:20px;
}

.complete{ background:#e6fff0; color:#007a3d }
.not{ background:#ffecec; color:#b00020 }

/* MODAL */
#modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  padding:30px;
}

.modal-box{
  background:white;
  max-width:900px;
  margin:auto;
  padding:20px;
  border-radius:12px;
  max-height:85vh;
  overflow:auto;
}

.item{
  border-bottom:1px solid #eee;
  padding:10px 0;
}

.item input[type=text]{
  width:60%;
}

button{
  padding:6px 10px;
  cursor:pointer;
}
</style>
</head>

<body>

<h2 id="progTitle">Programme Dashboard</h2>

<div class="area-grid" id="areaGrid"></div>

<!-- MODAL -->
<div id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>
    <div id="itemList"></div>
    <br>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbzzfNBLau1GPNucFLHvLUc_78B5M21SbE2AYYzbIA6QOLucZ8KDHQeAtM01U90V3kPvSw/exec";

let appendixData = [];
let currentArea = "";

async function loadData(){
  const res = await fetch(API_URL);
  appendixData = await res.json();
  renderAreas();
}

function renderAreas(){
  const areas = {};
  appendixData.forEach(a=>{
    if(!areas[a.APPENDIX]) areas[a.APPENDIX]=[];
    areas[a.APPENDIX].push(a);
  });

  const grid = document.getElementById("areaGrid");
  grid.innerHTML="";

  Object.entries(areas).forEach(([area,items])=>{
    const done = items.filter(i=>i.STATUS==="COMPLETE").length;
    const pct = Math.round(done/items.length*100);

    const div = document.createElement("div");
    div.className="area-card";
    div.onclick=()=>openArea(area);

    div.innerHTML=`
      <h4>${area}</h4>
      <span class="badge ${pct===100?"complete":"not"}">
        ${done}/${items.length} COMPLETE
      </span>

      <div class="progress">
        <div class="progress-bar" style="width:${pct}%"></div>
      </div>
      <small>${pct}% completed</small>
    `;

    grid.appendChild(div);
  });
}

function openArea(area){
  currentArea = area;
  document.getElementById("modalTitle").innerText = area;
  const list = document.getElementById("itemList");
  list.innerHTML="";

  appendixData
    .filter(a=>a.APPENDIX===area)
    .forEach(a=>{
      list.innerHTML+=`
        <div class="item">
          <b>${a["NO APPENDIX"]}</b> â€“ ${a.ITEM}<br>
          PIC: ${a.PIC_ROLE}<br><br>

          <label>
            <input type="checkbox"
              ${a.STATUS==="COMPLETE"?"checked":""}
              onchange="updateStatus('${a["NO APPENDIX"]}',this.checked)">
            COMPLETE
          </label>
          <br><br>

          <input type="text"
            placeholder="Paste Google Drive link"
            value="${a.DOC_LINK||""}"
            onchange="updateLink('${a["NO APPENDIX"]}',this.value)">
        </div>
      `;
    });

  document.getElementById("modal").style.display="block";
}

function closeModal(){
  document.getElementById("modal").style.display="none";
}

async function updateStatus(noAppendix,checked){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      appendix:noAppendix,
      status: checked?"COMPLETE":"NOT STARTED"
    })
  });
  loadData();
}

async function updateLink(noAppendix,link){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      appendix:noAppendix,
      status:"COMPLETE",
      doc_link:link
    })
  });
}

loadData();
</script>

</body>
</html>
