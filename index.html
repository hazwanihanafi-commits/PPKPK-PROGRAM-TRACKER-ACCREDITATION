<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>PPKPK â€“ Programme Accreditation Dashboard</title>

<style>
body {
  font-family: Inter, Arial, sans-serif;
  background:#f6f8fb;
  padding:30px;
}
h1 { margin-bottom:20px; }

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(380px,1fr));
  gap:20px;
}

.card {
  background:#fff;
  border-radius:14px;
  padding:20px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}

.badge {
  display:inline-block;
  padding:4px 12px;
  border-radius:20px;
  font-size:12px;
  margin-bottom:10px;
}
.ready { background:#e6fff0; color:#007a3d; }
.not-ready { background:#ffecec; color:#b00020; }

.tabs { display:flex; gap:14px; margin:14px 0; }
.tab {
  background:none; border:none; font-weight:600;
  cursor:pointer; color:#555;
}
.tab.active {
  color:#2563eb;
  border-bottom:2px solid #2563eb;
}

  .tab-content { display:none; }
.tab-content.show { display:block; }

table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td {
  border:1px solid #ddd;
  padding:6px;
}
th { background:#f1f5f9; }


.meta p { font-size:14px; margin:4px 0; }

.progress-ring {
  width:70px; height:70px;
  border-radius:50%;
  background:
    conic-gradient(#2563eb var(--p), #e5e7eb 0);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  margin-bottom:10px;
}

.area {
  margin-top:12px;
  border-top:1px solid #eee;
  padding-top:8px;
}
.area h4 { margin:6px 0; }

.item {
  display:flex;
  justify-content:space-between;
  font-size:13px;
  padding:6px 0;
  border-bottom:1px dashed #eee;
}
.item button {
  font-size:12px;
  padding:2px 8px;
  cursor:pointer;
}
</style>
</head>

<body>

<h1>ðŸ“˜ PPKPK â€“ Programme Accreditation Dashboard</h1>
<div id="grid" class="grid"></div>

<script>
const STUDENT_API =
"https://script.google.com/macros/s/AKfycbzveYXbtD0_WdOmaX5pXapE4mBZoT9lsMlLSi7nM8iGyErZ69WjJKRoBre9Wy6MTjXbkg/exec";

const APPENDIX_API =
"https://script.google.com/macros/s/AKfycbzzfNBLau1GPNucFLHvLUc_78B5M21SbE2AYYzbIA6QOLucZ8KDHQeAtM01U90V3kPvSw/exec";

async function loadDashboard() {
  const students = await fetch(STUDENT_API).then(r=>r.json());
  const appendix = await fetch(APPENDIX_API).then(r=>r.json());

  const programs = {};

  students.forEach(r=>{
    const p = r["ACADEMIC PROGRAM"];
    if(!p) return;

    if(!programs[p]) {
      programs[p] = {
        name:p,
        bm:r["PROGRAM AKADEMIK"],
        mqr:r["NO MQR"],
        centre:r["PEMILIK PROGRAM"],
        nec:r["NEC"],
        ketua:r["KETUA PROGRAM"],
        team:new Set(),
        students:[],
        aktif:0,
        graduan:0,
        tangguh:0,
        appendix:[]
      };
    }

    programs[p].students.push(r);

    if(r["STATUS PENGAJIAN"]==="AKTIF") programs[p].aktif++;
    if(r["STATUS PENGAJIAN"]==="BERIJAZAH") programs[p].graduan++;
    if(r["STATUS PENGAJIAN"]==="TANGGUH") programs[p].tangguh++;

    if(r["PENYELIA UTAMA"] && r["PENYELIA UTAMA"]!==r["KETUA PROGRAM"])
      programs[p].team.add(r["PENYELIA UTAMA"]);
  });

  appendix.forEach(a=>{
    const p=a["ACADEMIC PROGRAM"];
    if(programs[p]) programs[p].appendix.push(a);
  });

  render(programs);
}

function render(programs){
  const grid=document.getElementById("grid");
  grid.innerHTML="";

  Object.values(programs).forEach(p=>{
    const total=p.appendix.length;
    const done=p.appendix.filter(x=>x.STATUS==="COMPLETE").length;
    const percent=total?Math.round(done/total*100):0;

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <h3>${p.name}</h3>
      <div>${p.bm||""}</div>
      <span class="badge ${percent===100?'ready':'not-ready'}">
        ${percent===100?'READY':'NOT READY'}
      </span>

      <div class="progress-ring" style="--p:${percent}%">${percent}%</div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab(this)">Overview</button>
        <button class="tab" onclick="switchTab(this)">COPPA / SRR</button>
        <button class="tab" onclick="switchTab(this)">Students</button>
      </div>

      <div class="tab-content show">
        <p><b>MQR:</b> ${p.mqr}</p>
        <p><b>Centre:</b> ${p.centre}</p>
        <p><b>NEC:</b> ${p.nec}</p>
        <p><b>Ketua:</b> ${p.ketua}</p>
        <p><b>Team:</b> ${[...p.team].join(", ")||"-"}</p>
        <p>
          <b>Students:</b>
          Aktif ${p.aktif} |
          Graduan ${p.graduan} |
          Tangguh ${p.tangguh}
        </p>
      </div>

      <div class="tab-content">
        ${p.appendix.map(a=>`
          <div class="item">
            <span>${a["NO APPENDIX"]} â€“ ${a.ITEM}</span>
            <button onclick="updateStatus('${a["NO APPENDIX"]}',
              '${a.STATUS==="COMPLETE"?"NOT STARTED":"COMPLETE"}')">
              ${a.STATUS}
            </button>
          </div>
        `).join("")}
      </div>

      <div class="tab-content">
        <table>
          <tr><th>No Matrik</th><th>Nama</th><th>Status</th></tr>
          ${p.students.map(s=>`
            <tr>
              <td>${s["NO MATRIK"]||"-"}</td>
              <td>${s["NAMA PELAJAR"]||"-"}</td>
              <td>${s["STATUS PENGAJIAN"]||"-"}</td>
            </tr>
          `).join("")}
        </table>
      </div>
    `;

    grid.appendChild(card);
  });
}

function switchTab(btn){
  const card=btn.closest(".card");
  card.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  btn.classList.add("active");

  const tabs=card.querySelectorAll(".tab-content");
  tabs.forEach(t=>t.classList.remove("show"));
  tabs[[...btn.parentNode.children].indexOf(btn)].classList.add("show");
}

async function updateStatus(no,status){
  await fetch(APPENDIX_API,{
    method:"POST",
    body:JSON.stringify({ appendix:no, status })
  });
  loadDashboard();
}

loadDashboard();
</script>

</body>
</html>
