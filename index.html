<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PPKPK â€“ SRR Programme Dashboard</title>

<style>
body{
  font-family:Arial,sans-serif;
  background:#f6f8fb;
  padding:24px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(420px,1fr));
  gap:20px;
}

.card{
  background:white;
  border-radius:14px;
  padding:20px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}

.badge{
  padding:4px 12px;
  border-radius:20px;
  font-size:12px;
}

.ready{background:#e6fff0;color:#047857}
.not{background:#ffecec;color:#991b1b}

button{padding:6px 12px;cursor:pointer}

/* MODAL */
#modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  padding:30px;
  z-index:9999;
}

.modal-box{
  background:white;
  max-width:1000px;
  margin:auto;
  padding:20px;
  border-radius:14px;
  max-height:90vh;
  overflow:auto;
}

.tabs{
  display:flex;
  gap:10px;
  margin:12px 0;
}

.tabs button{
  border:none;
  background:#eee;
  padding:6px 14px;
  border-radius:20px;
}

.tabs button.active{
  background:#2563eb;
  color:white;
}

.area-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:14px;
}

.area-card{
  border:1px solid #eee;
  border-radius:10px;
  padding:12px;
  cursor:pointer;
}

.progress{
  height:8px;
  background:#eee;
  border-radius:6px;
  overflow:hidden;
  margin-top:6px;
}

.progress div{
  height:100%;
  background:#22c55e;
}
</style>
</head>

<body>

<h2>ðŸ“˜ PPKPK â€“ Programme SRR Dashboard</h2>

<div id="programmeGrid" class="grid"></div>

<!-- PROGRAMME MODAL -->
<div id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>

    <div class="tabs">
      <button onclick="showTab('overview')" class="active">Overview</button>
      <button onclick="showTab('students')">Students</button>
      <button onclick="showTab('coppa')">COPPA Evidence</button>
    </div>

    <div id="overviewTab"></div>
    <div id="studentsTab" style="display:none"></div>
    <div id="coppaTab" style="display:none"></div>

    <br>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const STUDENT_API = "STUDENT_MASTER_API_URL";
const APPENDIX_API =
 "https://script.google.com/macros/s/AKfycbzzfNBLau1GPNucFLHvLUc_78B5M21SbE2AYYzbIA6QOLucZ8KDHQeAtM01U90V3kPvSw/exec";

let students = [];
let appendix = [];
let currentProgram = "";

/* ===================== LOAD DATA ===================== */
async function loadAll(){
  students = await (await fetch(STUDENT_API)).json();
  appendix = await (await fetch(APPENDIX_API)).json();
  renderPrograms();
}

/* ===================== MAIN DASHBOARD ===================== */
function renderPrograms(){
  const programs = {};

  students.forEach(s=>{
    const p = s["PROGRAM AKADEMIK"];
    if(!programs[p]) programs[p]={students:[]};
    programs[p].students.push(s);
  });

  const grid = document.getElementById("programmeGrid");
  grid.innerHTML="";

  Object.entries(programs).forEach(([name,p])=>{
    const grads = p.students.filter(s=>s["STATUS PENGAJIAN"]==="BERIJAZAH").length;

    grid.innerHTML+=`
      <div class="card">
        <h3>${name}</h3>
        <span class="badge ${grads>0?"ready":"not"}">
          ${grads>0?"READY":"NOT READY"}
        </span>
        <p>Graduan: ${grads}</p>
        <button onclick="openProgramme('${name}')">
          View Programme Dashboard
        </button>
      </div>
    `;
  });
}

/* ===================== MODAL ===================== */
function openProgramme(program){
  currentProgram = program;
  document.getElementById("modalTitle").innerText = program;
  showTab("overview");
  loadOverview();
  loadStudents();
  loadCoppa();
  document.getElementById("modal").style.display="block";
}

function closeModal(){
  document.getElementById("modal").style.display="none";
}

function showTab(tab){
  ["overview","students","coppa"].forEach(t=>{
    document.getElementById(t+"Tab").style.display =
      t===tab?"block":"none";
  });
  document.querySelectorAll(".tabs button")
    .forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}

/* ===================== OVERVIEW ===================== */
function loadOverview(){
  const list = students.filter(s=>s["PROGRAM AKADEMIK"]===currentProgram);
  const aktif = list.filter(s=>s["STATUS PENGAJIAN"]==="AKTIF").length;
  const grad = list.filter(s=>s["STATUS PENGAJIAN"]==="BERIJAZAH").length;

  document.getElementById("overviewTab").innerHTML=`
    <p><b>Aktif:</b> ${aktif}</p>
    <p><b>Graduan:</b> ${grad}</p>
  `;
}

/* ===================== STUDENTS ===================== */
function loadStudents(){
  const list = students.filter(s=>s["PROGRAM AKADEMIK"]===currentProgram);
  document.getElementById("studentsTab").innerHTML =
    list.map(s=>`
      <p>ðŸ‘¤ ${s["NAMA PELAJAR"]} â€“ ${s["STATUS PENGAJIAN"]}</p>
    `).join("");
}

/* ===================== COPPA ===================== */
function loadCoppa(){
  const areas={};
  appendix.forEach(a=>{
    if(!areas[a.APPENDIX]) areas[a.APPENDIX]=[];
    areas[a.APPENDIX].push(a);
  });

  document.getElementById("coppaTab").innerHTML =
    `<div class="area-grid">${
      Object.entries(areas).map(([area,items])=>{
        const done = items.filter(i=>i.STATUS==="COMPLETE").length;
        const pct = Math.round(done/items.length*100);
        return `
          <div class="area-card">
            <b>${area}</b>
            <div>${done}/${items.length} COMPLETE</div>
            <div class="progress">
              <div style="width:${pct}%"></div>
            </div>
          </div>
        `;
      }).join("")
    }</div>`;
}

loadAll();
</script>

</body>
</html>
