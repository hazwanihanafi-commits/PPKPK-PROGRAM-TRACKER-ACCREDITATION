<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PPKPK â€“ SRR Programme Readiness Dashboard</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f6f8fb;
  padding:24px;
}

h2 { margin-bottom:20px; }

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(480px,1fr));
  gap:20px;
}

.card {
  background:#fff;
  border-radius:14px;
  padding:20px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.badge {
  display:inline-block;
  padding:5px 14px;
  border-radius:20px;
  font-size:12px;
  margin:6px 0;
}
.ready { background:#e6fff0; color:#007a3d; }
.not-ready { background:#ffecec; color:#b00020; }

.progress {
  background:#eee;
  height:8px;
  border-radius:10px;
  overflow:hidden;
  margin:10px 0;
}
.progress span {
  display:block;
  height:100%;
  background:#2563eb;
}

.tabs {
  display:flex;
  gap:16px;
  margin:14px 0;
}
.tab {
  background:none;
  border:none;
  font-weight:bold;
  cursor:pointer;
  color:#555;
}
.tab.active {
  color:#2563eb;
  border-bottom:2px solid #2563eb;
}

.meta p { font-size:14px; margin:4px 0; }

button {
  padding:6px 12px;
  border-radius:6px;
  border:1px solid #ccc;
  background:#fff;
  cursor:pointer;
}

/* MODAL */
#modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  padding:40px;
  z-index:9999;
}
#modal .box {
  background:#fff;
  border-radius:14px;
  padding:20px;
  max-width:1000px;
  margin:auto;
  max-height:85vh;
  overflow:auto;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td {
  border:1px solid #ccc;
  padding:6px;
  font-size:13px;
}
th { background:#eee; }
</style>
</head>

<body>

<h2>ðŸ“˜ PPKPK â€“ SRR Programme Readiness Dashboard</h2>

<div id="programmeGrid" class="grid"></div>

<!-- MODAL -->
<div id="modal">
  <div class="box">
    <h3 id="modalTitle"></h3>

    <h4>ðŸ‘¥ Student List</h4>
    <table>
      <thead>
        <tr>
          <th>No Matrik</th>
          <th>Nama Pelajar</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="studentBody"></tbody>
    </table>

    <h4 style="margin-top:20px">ðŸ“‚ COPPA / SRR Appendix</h4>
    <table>
      <thead>
        <tr>
          <th>Area</th>
          <th>Appendix</th>
          <th>Item</th>
          <th>Status</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody id="appendixBody"></tbody>
    </table>

    <br>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const STUDENT_API =
"https://script.google.com/macros/s/AKfycbzveYXbtD0_WdOmaX5pXapE4mBZoT9lsMlLSi7nM8iGyErZ69WjJKRoBre9Wy6MTjXbkg/exec";

const APPENDIX_API =
"https://script.google.com/macros/s/AKfycbzzfNBLau1GPNucFLHvLUc_78B5M21SbE2AYYzbIA6QOLucZ8KDHQeAtM01U90V3kPvSw/exec";

const TOTAL_APPENDIX = 56;

/* ================= LOAD ================= */
async function loadDashboard() {
  const students = await fetch(STUDENT_API).then(r=>r.json());
  const appendix = await fetch(APPENDIX_API).then(r=>r.json());

  const programmes = {};

  students.forEach(row=>{
    const prog = row["ACADEMIC PROGRAM"];
    if (!prog) return;

    if (!programmes[prog]) {
      programmes[prog] = {
        academic: row["ACADEMIC PROGRAM"],
        bm: row["PROGRAM AKADEMIK"],
        mqr: row["NO MQR"],
        owner: row["PEMILIK PROGRAM"],
        nec: row["NEC"],
        ketua: row["KETUA PROGRAM"],
        team:new Set(),
        students:[],
        complete:0
      };
    }

    if (row["PENYELIA UTAMA"] &&
        row["PENYELIA UTAMA"] !== programmes[prog].ketua) {
      programmes[prog].team.add(row["PENYELIA UTAMA"]);
    }

    programmes[prog].students.push(row);
  });

  // count appendix completion (shared for demo)
  const completed = appendix.filter(a=>a.STATUS==="COMPLETE").length;

  const grid = document.getElementById("programmeGrid");
  grid.innerHTML="";

  Object.values(programmes).forEach(p=>{
    const percent = Math.round((completed / TOTAL_APPENDIX) * 100);
    const ready = percent === 100;

    const card = document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <h3>${p.academic}</h3>
      <div style="color:#666">${p.bm}</div>

      <span class="badge ${ready?"ready":"not-ready"}">
        ${ready?"READY":"NOT READY"}
      </span>

      <div class="progress">
        <span style="width:${percent}%"></span>
      </div>
      <b>${percent}% COMPLETE</b><br>
      ${completed}/${TOTAL_APPENDIX} appendix completed

      <div class="tabs">
        <button class="tab active" onclick="switchTab(this,'overview')">Overview</button>
        <button class="tab" onclick="switchTab(this,'coppa')">COPPA Evidence</button>
        <button class="tab" onclick="switchTab(this,'docs')">Documents</button>
      </div>

      <div class="tab-content overview meta">
        <p><b>NO MQR:</b> ${p.mqr}</p>
        <p><b>Owner:</b> ${p.owner}</p>
        <p><b>NEC:</b> ${p.nec}</p>
        <p><b>Ketua Program:</b> ${p.ketua}</p>
        <p><b>Team:</b> ${[...p.team].join(", ")||"-"}</p>
        <button onclick='openModal("${p.academic}")'>Open Programme</button>
      </div>

      <div class="tab-content coppa" style="display:none">
        âœ” COPPA mapping<br>
        âœ” Assessment alignment<br>
        âœ” CQI evidence
      </div>

      <div class="tab-content docs" style="display:none">
        SRR Report<br>
        Course Files<br>
        Examiner Reports
      </div>
    `;

    grid.appendChild(card);
  });
}

/* ================= MODAL ================= */
async function openModal(program) {
  document.getElementById("modalTitle").innerText = program;
  document.getElementById("modal").style.display="block";

  const students = await fetch(STUDENT_API).then(r=>r.json());
  const appendix = await fetch(APPENDIX_API).then(r=>r.json());

  const sbody=document.getElementById("studentBody");
  sbody.innerHTML="";
  students.filter(s=>s["ACADEMIC PROGRAM"]===program)
    .forEach(s=>{
      sbody.innerHTML+=`
      <tr>
        <td>${s["NO MATRIK"]}</td>
        <td>${s["NAMA PELAJAR"]}</td>
        <td>${s["STATUS PENGAJIAN"]}</td>
      </tr>`;
    });

  const abody=document.getElementById("appendixBody");
  abody.innerHTML="";
  appendix.forEach(a=>{
    abody.innerHTML+=`
    <tr>
      <td>${a.APPENDIX}</td>
      <td>${a["NO APPENDIX"]}</td>
      <td>${a.ITEM}</td>
      <td>${a.STATUS}</td>
      <td>${a.DOC_LINK?
        `<a href="${a.DOC_LINK}" target="_blank">View</a>`:"-"}</td>
    </tr>`;
  });
}

function closeModal(){
  document.getElementById("modal").style.display="none";
}

/* ================= TABS ================= */
function switchTab(btn,tab){
  const card=btn.closest(".card");
  card.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  btn.classList.add("active");
  card.querySelectorAll(".tab-content").forEach(c=>c.style.display="none");
  card.querySelector("."+tab).style.display="block";
}

loadDashboard();
</script>

</body>
</html>
